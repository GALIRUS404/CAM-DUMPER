
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
  <title>Ruangan Chat</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Ubuntu', sans-serif;
      background-color: #212121;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }

    #chatMessages {
      width: 100%;
      max-width: 900px;
      height: 70vh;
      background-color: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      scroll-behavior: smooth;
    }

    .info-container {
      text-align: center;
      margin-bottom: 20px;
      color: #ffffff;
    }

    .user-info p, .status-info p, .server-info p {
      color: #81c784;
      font-size: 1.1rem;
    }

    .message {
      background-color: #f7f7f7;
      padding: 15px;
      border-radius: 12px;
      font-size: 1rem;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      max-width: 80%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(20px);
      animation: fadeIn 0.5s forwards, slideUp 0.5s forwards;
      cursor: pointer; /* Menambahkan kursor pointer */
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      to {
        transform: translateY(0);
      }
    }

    .message:hover {
      background-color: #d3d3d3;
    }

    .user-message {
      background-color: #a8e6cf;
      align-self: flex-end;
      border-radius: 12px 12px 0 12px;
    }

    .other-message {
      background-color: #ffffff;
      align-self: flex-start;
      border-radius: 12px 12px 12px 0;
    }

    #messageInput {
      width: 100%;
      padding: 12px;
      border-radius: 30px;
      border: 2px solid #4caf50;
      font-size: 1rem;
      outline: none;
      margin-bottom: 10px;
      box-sizing: border-box;
      background-color: #333;
      color: #fff;
    }

    #messageInput:focus {
      border-color: #81c784;
    }

    .button-icon {
      font-size: 1.5rem;
      background-color: transparent;
      border: none;
      cursor: pointer;
      padding: 10px;
      color: #81c784;
      transition: color 0.2s;
    }

    .button-icon:hover {
      color: #66bb6a;
    }

    h1 {
      font-size: 2.5rem;
      color: #ffffff;
      margin-bottom: 20px;
    }

    .reply-container {
      margin-bottom: 10px;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 0.9rem;
      border-left: 4px solid #81c784;
      border-radius: 5px;
      position: relative;
    }

    .reply-container span {
      font-weight: bold;
      color: #81c784;
    }

    .reply-container .cancel-reply {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      color: #e57373;
      font-weight: bold;
    }

    .delete-icon {
      font-size: 0.8rem; /* Ukuran lebih kecil */
      color: #e57373;
      cursor: pointer;
      position: absolute;
      bottom: 5px; /* Pindah ke bawah */
      right: 5px; /* Pindah ke kanan */
    }

    .reply-message {
      background-color: #e0f7fa;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #4db6ac;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <h1>Ruangan Chat</h1>

  <div class="info-container">
    <div class="user-info">
      <p>Anda login sebagai: <strong id="userIdDisplay"></strong> (<span id="userNameDisplay"></span>)</p>
    </div>
    <div class="status-info">
      <p id="onlineStatus">Pengguna Online: </p>
    </div>
    <div class="server-info">
      <p id="serverStatus">Server Running: --:--:--</p>
    </div>
  </div>

  <div id="chatMessages"></div>

  <div id="replyContainer" class="reply-container" style="display: none;">
    Membalas: <span id="replyText"></span>
    <span class="cancel-reply" onclick="cancelReply()">√ó</span>
  </div>

  <div style="display: flex; align-items: center; gap: 10px;">
    <input type="text" id="messageInput" placeholder="Ketik pesan Anda" />
    <button class="button-icon" id="fileButton">üì•</button>
    <button class="button-icon" onclick="sendMessage()">üì®</button>
    <input type="file" id="fileInput" style="display: none;" />
  </div>

  <!-- Elemen Audio untuk Notifikasi dan Pengirim Pesan -->
  <audio id="notificationAudio" src="https://od.lk/s/OV8yNDUxODMyNzdf/livechat-129007.mp3" preload="auto"></audio>
  <audio id="sendAudio" src="https://od.lk/s/OV8yNDUxODM1NTdf/happy-pop-2-185287.mp3" preload="auto"></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const phone = sessionStorage.getItem('phone');
    const userId = sessionStorage.getItem('userId');
    const userName = sessionStorage.getItem('name');

    if (!phone || !userId || !userName) {
      alert('Anda harus login untuk melanjutkan');
      window.location.href = '/login';
    } else {
      document.getElementById('userIdDisplay').textContent = userId;
      document.getElementById('userNameDisplay').textContent = userName;
    }

    const socket = io();
    const displayedMessages = new Set();
    let replyToMessage = null;

    async function loadChatHistory() {
      try {
        const response = await fetch('/chat-history');
        const chatHistory = await response.json();
        chatHistory.forEach(displayMessage);
      } catch (error) {
        console.error('Gagal memuat riwayat chat:', error);
      }
    }

    function formatTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function sanitizeInput(input) {
      const doc = new DOMParser().parseFromString(input, 'text/html');
      return doc.body.textContent || "";
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const fileInput = document.getElementById('fileInput');
      const messageText = messageInput.value;
      const file = fileInput.files[0];

      if (messageText.trim() === '' && !file) return;

      const sanitizedMessage = sanitizeInput(messageText);

      const message = {
        userId: userId,
        phone: phone,
        name: userName,
        text: sanitizedMessage,
        timestamp: new Date().toISOString(),
        file: null,
        replyTo: replyToMessage,
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          message.file = {
            name: file.name,
            type: file.type,
            size: file.size,
            content: event.target.result
          };
          socket.emit('chat message', message);
        };
        reader.readAsDataURL(file);
      } else {
        socket.emit('chat message', message);
      }

      // Memutar suara pengirim pesan
      const sendAudio = document.getElementById('sendAudio');
      sendAudio.currentTime = 0; // Mulai dari awal
      sendAudio.play();

      replyToMessage = null;
      updateReplyUI();
      messageInput.value = '';
      fileInput.value = '';
    }

    function displayMessage(message) {
      if (displayedMessages.has(message.timestamp)) return;

      displayedMessages.add(message.timestamp);

      const chatMessages = document.getElementById('chatMessages');
      const messageElement = document.createElement('div');

      messageElement.classList.add('message');
      messageElement.classList.add(message.userId === userId ? 'user-message' : 'other-message');

      const sanitizedMessageText = sanitizeInput(message.text);

      let replyHtml = '';
      if (message.replyTo) {
        const replyText = sanitizeInput(message.replyTo.text);
        const replyUser = sanitizeInput(message.replyTo.name); // Nama pengirim pesan yang dibalas
        replyHtml = `
          <div style="font-size: 0.9rem; color: #888; margin-bottom: 5px; border-left: 4px solid #81c784; padding-left: 10px;">
            <strong>Balasan ke ${replyUser}:</strong> ${replyText}
          </div>`;
      }

      messageElement.innerHTML = `
        ${replyHtml}
        <strong>${message.name} (${message.userId}):</strong><br>${sanitizedMessageText}
        <br><small>(${new Date(message.timestamp).toLocaleTimeString()})</small>
        <span class="delete-icon" onclick="confirmDeleteMessage('${message.timestamp}')">üóëÔ∏è</span>
      `;

      // Menampilkan file jika ada
      if (message.file) {
        const fileType = message.file.type.split('/')[0];
        if (fileType === 'video') {
          messageElement.innerHTML += `<video width="300" controls>
            <source src="${message.file.content}" type="${message.file.type}">
            Browser Anda tidak mendukung video.
          </video>`;
        } else if (fileType === 'audio') {
          messageElement.innerHTML += `<audio controls>
            <source src="${message.file.content}" type="${message.file.type}">
            Browser Anda tidak mendukung audio.
          </audio>`;
        } else if (fileType === 'image') {
          messageElement.innerHTML += `<img src="${message.file.content}" alt="${message.file.name}" width="300" />`;
        } else {
          messageElement.innerHTML += `<p>File: ${message.file.name} (${Math.round(message.file.size / 1024)} KB)</p>`;
        }
      }

      // Menambahkan event listener untuk reply message
      messageElement.onclick = function() {
        initiateReply(message);
        document.getElementById('messageInput').focus(); // Fokus pada input message
      };

      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Memutar notifikasi suara untuk pesan dari pengguna lain
      if (message.userId !== userId) {
        const notificationAudio = document.getElementById('notificationAudio');
        notificationAudio.currentTime = 0; // Mulai dari awal
        notificationAudio.play();
      }
    }

    function confirmDeleteMessage(timestamp) {
      const password = prompt("Masukkan password untuk menghapus pesan:");
      if (password) {
        deleteMessage(timestamp, password);
      }
    }

    function deleteMessage(timestamp, password) {
      fetch('/delete-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ timestamp, password }),
      })
      .then(response => {
        if (response.ok) {
          alert('Pesan berhasil dihapus');
          location.reload(); // Memuat ulang halaman untuk melihat perubahan
        } else {
          alert('Gagal menghapus pesan: password salah atau tidak memiliki hak');
        }
      })
      .catch(error => {
        console.error('Terjadi kesalahan:', error);
      });
    }

    function initiateReply(message) {
      replyToMessage = message;
      updateReplyUI();
    }

    function updateReplyUI() {
      const replyContainer = document.getElementById('replyContainer');
      const replyText = document.getElementById('replyText');

      if (replyToMessage) {
        replyContainer.style.display = 'block';
        replyText.textContent = sanitizeInput(replyToMessage.text);
      } else {
        replyContainer.style.display = 'none';
        replyText.textContent = '';
      }
    }

    function cancelReply() {
      replyToMessage = null;
      updateReplyUI();
    }

    socket.on('chat message', (message) => {
      displayMessage(message);
    });

    socket.on('online users', (count) => {
      const onlineStatus = document.getElementById('onlineStatus');
      onlineStatus.textContent = `Pengguna Online: ${count}`;
    });

    socket.on('server uptime', (uptimeInSeconds) => {
      const serverStatus = document.getElementById('serverStatus');
      serverStatus.textContent = `Server Running: ${formatTime(uptimeInSeconds)}`;
    });

    document.getElementById('fileButton').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    loadChatHistory();
  </script>

</body>
</html>
